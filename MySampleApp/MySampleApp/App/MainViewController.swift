//
//  MainViewController.swift
//  MySampleApp
//
//
// Copyright 2016 Amazon.com, Inc. or its affiliates (Amazon). All Rights Reserved.
//
// Code generated by AWS Mobile Hub. Amazon gives unlimited permission to 
// copy, distribute and modify it.
//
// Source code generated from template: aws-my-sample-app-ios-swift v0.1
//

import UIKit
import AWSMobileHubHelper
import Firebase
import SafariServices

class MainViewController: UIViewController, HypeAdStoreDelegate {
    
    @IBOutlet var countLabel: UILabel!
    @IBOutlet var progressBar: KYCircularProgress!
    @IBOutlet var kolodaView: KolodaView!
    @IBOutlet var mainSpinner: UIActivityIndicatorView!
    
    private var downloadContentsIndices: [Int] = []
    var manager: AWSContentManager!
    
    var adStore: HypeAdStore!
    
    //TODO change this
    var adCount: Int = 0
    var contentCount: Int = 0
    var userFBRef: Firebase!
    
    var userUID: String!{
        didSet{
            let tempRef = Firebase(url: "https://enas400hype.firebaseio.com/")
            userFBRef = tempRef.childByAppendingPath("users").childByAppendingPath(userUID)
        }
    }
    
    var keyForFriend: String!{
        didSet{
            self.performSegueWithIdentifier("showUsersTableViewSegue", sender: nil)
        }
    }
    
    //Create subview for kolodaView, add Koloda view, and pass protocols
    override func viewDidLoad() {
        super.viewDidLoad()
        
        mainSpinner.startAnimating()
        
        progressBar.lineWidth = 10.0
        progressBar.guideLineWidth = 10.0
        progressBar.progressGuideColor = UIColor(red: 212/255, green: 212/255, blue: 212/255, alpha: 1)
        progressBar.showProgressGuide = true
        progressBar.colors = [UIColor(red: 255/255, green: 56/255, blue: 73/255, alpha: 1)]
        
        kolodaView.dataSource = self
        kolodaView.delegate = self
        
        self.modalTransitionStyle = UIModalTransitionStyle.FlipHorizontal
        
    }
    
    override func viewDidAppear(animated: Bool) {

        userFBRef.observeSingleEventOfType(.Value, withBlock: { (snapshot) in
            let data = snapshot.value["contentCount"] as? Int
            if let t = data{
                self.contentCount = t
                self.countLabel.text = "\(self.contentCount)"
            }
            let adsViewed = snapshot.value["adViewedCount"] as? Int
            if let t = adsViewed{
                self.adCount = t
                let progress = t % Constants.ADSPERCONTENT
                self.progressBar.progress = Double(progress + 1)/Double(Constants.ADSPERCONTENT)
            }
            //add error handler?
            
        })
    }
    
    func initImageStore(){
        adStore = HypeAdStore(delegate: self, awsManager: manager)
        let fbRef = userFBRef.childByAppendingPath("adsFromFriends")
        fbRef.observeEventType(.ChildAdded, withBlock: { (snapshot) in
            let contentKey = snapshot.value as? String
            if let key = contentKey{
                self.adStore.addContentByKey(key, shouldDownload: true)
            }
        })
        
        adStore.initializeCardsFromAWS()
    }
    
    func checkAdCount(){
        userFBRef.childByAppendingPath("adViewedCount").setValue(adCount)
        let progress = adCount % Constants.ADSPERCONTENT
        progressBar.progress = Double(progress + 1)/Double(Constants.ADSPERCONTENT)
        if(progress) == 0 {
            contentCount++
            self.countLabel.text = "\(self.contentCount)"
            userFBRef.childByAppendingPath("contentCount").setValue(contentCount)
        }
    }
    
    @IBAction func onSwipeRightClicked(sender: AnyObject){
        kolodaView.swipe(SwipeResultDirection.Right)
    }
    @IBAction func onSwipeLeftClicked(sender: AnyObject){
        kolodaView.swipe(SwipeResultDirection.Left)
    }
    
    func newCardImageLoaded(cardIndex: Int){
        downloadContentsIndices.append(cardIndex)
        if downloadContentsIndices.count == 1 {
            kolodaView.reloadData()
            mainSpinner.stopAnimating()
        }
    }
    
    @IBAction func unwindFromUsersSegue(segue: UIStoryboardSegue){
        
    }

}

// KolodaView protocol that determines what cards to show
extension MainViewController: KolodaViewDataSource{
    func koloda(kolodaNumberOfCards koloda:KolodaView) -> UInt {
        return UInt(downloadContentsIndices.count)
        
    }
    
    //Return a new view (card) to show from ImageStore
    func koloda(koloda: KolodaView, viewForCardAtIndex index: UInt) -> UIView {
        let cardIndex = downloadContentsIndices[Int(index)]
        if let image = adStore.getContentImageAtCardIndex(cardIndex) {
//            let newView = UIImageView(image: image)
//            let newContainerView = UIView(frame: kolodaView.frameForCardAtIndex(0))
            let superFrame = kolodaView.frameForCardAtIndex(0)
            let newContainerView = UIView(frame: superFrame)
            newContainerView.layer.cornerRadius = 20
            
            if adStore.getIsFromFriendAtCardIndex(cardIndex){
                newContainerView.backgroundColor = UIColor(red: 255/255, green: 56/255, blue: 73/255, alpha: 1.0)
            } else {
                newContainerView.backgroundColor = UIColor.whiteColor()
            }
            newContainerView.layer.shadowOpacity = 0.7
            newContainerView.layer.shadowOffset = CGSizeZero
            newContainerView.layer.shadowRadius = 10
            
//            newContainerView.layer.borderColor = UIColor.blackColor().CGColor
//            newContainerView.layer.borderWidth = 2.0
            
//            newContainerView.backgroundColor = UIColor.redColor()
            
            let childFrame = CGRectInset(superFrame, 7, 7)
            let newChildView = UIImageView(frame: childFrame)
            newChildView.image = image
            newChildView.layer.masksToBounds = true
            newChildView.layer.cornerRadius = 20
            newContainerView.addSubview(newChildView)
            
            return newContainerView
        } else {
            let newView = UIView()
            let colorArray = [UIColor.blueColor(), UIColor.redColor(), UIColor.greenColor()]
            let index = arc4random_uniform(3)
            newView.backgroundColor = colorArray[Int(index)]
            return newView
        }
    }
    
    override func prepareForSegue(segue: UIStoryboardSegue, sender: AnyObject?) {

        if segue.identifier == "showUsersTableViewSegue" {
            let newVC = segue.destinationViewController as! UsersTableViewController
            newVC.keyForFriend = keyForFriend
            newVC.ownUID = userUID
            
        }
    }
        
}

// Own implemenation upon swiping so can clear image cache of given card
extension MainViewController: KolodaViewDelegate {
    func koloda(koloda: KolodaView, didSwipedCardAtIndex index: UInt, inDirection direction: SwipeResultDirection) {
        

//        
//        if index % 3 == 0 && index > 0{
//            adStore.downloadMoreCards(3)
//        }
        
        adCount++
        checkAdCount()
        adStore.clearCacheAtCardIndex(downloadContentsIndices[Int(index)])
        
        if direction == .Right {
            let newFBRef = userFBRef.childByAppendingPath("cardsLiked")
            adStore.pushImageKeyAtCardIndex(downloadContentsIndices[Int(index)], fbRef: newFBRef)
        } else if direction == SwipeResultDirection.Up{
            if let key = adStore.getContentKeyAtIndex(downloadContentsIndices[Int(index)]){
                keyForFriend = key
            }
        }
        
        print("Swiped: \(index) of \(adStore.getNumAvailCards()) cards")
        if Int(index + 1) == adStore.getNumAvailCards() {
            mainSpinner.startAnimating()
            adStore.resetCardsToReload()
            downloadContentsIndices.removeAll()
            adStore.downloadMoreCards(adStore.getNumAvailCards())
            kolodaView.resetCurrentCardNumber()
            
        }
        
    }
    
    func koloda(koloda: KolodaView, didSelectCardAtIndex index: UInt) {
        if let url = NSURL(string: "http://www.githyped.com/"){
            if #available(iOS 9.0, *) {
                let vc = SFSafariViewController(URL: url, entersReaderIfAvailable: false)
                 presentViewController(vc, animated: true, completion: nil)
            } else {
                // Fallback on earlier versions
            }
           
        }
    }
    
    func koloda(kolodaDidRunOutOfCards koloda: KolodaView) {
        //Example: reloading
        kolodaView.reloadData()
    }
}





